# =============================================================================
# Cardea Zeek Configuration
# =============================================================================
# Zeek's Role in Cardea: Deep protocol analysis and behavioral detection
# - Provides rich metadata that Suricata cannot extract
# - Feeds KitNET ML model with detailed connection features
# - Detects anomalies through protocol analysis (not signatures)
# =============================================================================

# -----------------------------------------------------------------------------
# Core Frameworks
# -----------------------------------------------------------------------------
@load base/frameworks/logging
@load base/frameworks/notice
@load base/frameworks/intel
@load base/frameworks/files
@load base/frameworks/signatures
@load base/frameworks/sumstats
@load base/frameworks/software

# -----------------------------------------------------------------------------
# Protocol Analyzers - Generate rich metadata logs
# -----------------------------------------------------------------------------
# Network layer
@load base/protocols/conn
@load base/protocols/icmp

# Application layer - Critical for security visibility
@load base/protocols/dns
@load base/protocols/http
@load base/protocols/ssl
@load base/protocols/ftp
@load base/protocols/ssh
@load base/protocols/smtp
@load base/protocols/irc
@load base/protocols/dhcp
@load base/protocols/ntlm
@load base/protocols/smb
@load base/protocols/dce-rpc
@load base/protocols/krb
@load base/protocols/rdp
@load base/protocols/sip
@load base/protocols/snmp
@load base/protocols/socks
@load base/protocols/tunnels

# -----------------------------------------------------------------------------
# Security-Focused Policy Scripts
# -----------------------------------------------------------------------------
# Detection capabilities that complement Suricata
@load policy/frameworks/notice/extend-email/hostnames

# Scan detection (Suricata needs rules, Zeek detects behaviorally)
@load policy/misc/scan
@load policy/misc/detect-traceroute

# Software tracking (version vulnerabilities)
@load policy/frameworks/software/version-changes
@load policy/frameworks/software/vulnerable

# SSL/TLS deep inspection (Zeek excels here)
@load policy/protocols/ssl/validate-certs
@load policy/protocols/ssl/log-hostcerts-only
@load policy/protocols/ssl/notary

# DNS analysis (tunneling, DGA detection support)
@load policy/protocols/dns/detect-external-names
@load policy/protocols/dns/auth-addl

# HTTP inspection
@load policy/protocols/http/detect-sqli
@load policy/protocols/http/detect-webapps
@load policy/protocols/http/software

# SSH analysis
@load policy/protocols/ssh/detect-bruteforcing
@load policy/protocols/ssh/geo-data
@load policy/protocols/ssh/interesting-hostnames
@load policy/protocols/ssh/software

# SMB/Windows protocol analysis
@load policy/protocols/smb/log-cmds
@load policy/protocols/conn/known-hosts
@load policy/protocols/conn/known-services

# File analysis (hash extraction for threat intel)
@load policy/frameworks/files/hash-all-files
@load policy/frameworks/files/detect-MHR

# Intel framework for IOC matching
@load policy/frameworks/intel/seen
@load policy/frameworks/intel/do_notice

# Weird/anomalous traffic detection
@load base/frameworks/notice/weird

# -----------------------------------------------------------------------------
# JSON Output Configuration
# -----------------------------------------------------------------------------
redef LogAscii::output_to_file = T;
redef LogAscii::json_timestamps = JSON::TS_ISO8601;
redef LogAscii::use_json = T;

# -----------------------------------------------------------------------------
# Performance Tuning
# -----------------------------------------------------------------------------
# Increase connection timeout for long-lived connections
redef tcp_inactivity_timeout = 5 min;
redef udp_inactivity_timeout = 1 min;

# Enable more detailed connection tracking
redef record_all_packets = F;  # Disable to save resources
redef ignore_checksums = T;    # Common in containerized environments

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------
# Define local networks (adjust to match your environment)
redef Site::local_nets += {
    192.168.0.0/16,
    10.0.0.0/8,
    172.16.0.0/12
};

# -----------------------------------------------------------------------------
# Notice Framework Configuration
# -----------------------------------------------------------------------------
# Route notices to notice.log (Bridge will consume these)
hook Notice::policy(n: Notice::Info) {
    add n$actions[Notice::ACTION_LOG];
}

# -----------------------------------------------------------------------------
# File Analysis Configuration  
# -----------------------------------------------------------------------------
# Extract file hashes for threat intelligence matching
redef FileExtract::prefix = "/opt/zeek/logs/extract_files/";

# Hash all transferred files
redef Files::enable_md5 = T;
redef Files::enable_sha1 = T;
redef Files::enable_sha256 = T;

# -----------------------------------------------------------------------------
# Log Rotation Configuration
# -----------------------------------------------------------------------------
# Rotate logs every hour to prevent disk exhaustion
redef Log::default_rotation_interval = 1 hr;

# Archive format: logs/YYYY-MM-DD/log.HH:MM:SS-HH:MM:SS.log.gz
redef Log::default_rotation_dir = "/opt/zeek/logs/archive";

# Compress rotated logs
redef Log::default_rotation_postprocessor_cmd = "gzip -9";

# Keep 7 days of logs (handled by external cleanup, but set Zeek limit)
# Note: Implement a cron job or systemd timer to purge logs older than 7 days:
#   find /opt/zeek/logs/archive -type f -mtime +7 -delete

# Per-log rotation overrides (if needed)
# redef Log::rotation_interval_table: table[Log::ID] of interval = {
#     [Conn::LOG] = 30 mins,     # High-volume log rotates faster
#     [Notice::LOG] = 24 hrs,    # Low-volume, keep longer
# };